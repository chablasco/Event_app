<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EventApp ‚Äì Skapa & Dela Event</title>
  <style>
    :root {
      --bg: #0f172a;       /* default slate-900 */
      --fg: #e2e8f0;       /* default slate-200 */
      --card: #111827;     /* slate-900-ish */
      --muted: #94a3b8;    /* slate-400 */
      --accent: #2563eb;   /* blue-600 */
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg); font-family: var(--font);
      display: flex; flex-direction: column; min-height: 100vh;
    }
    header {
      position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px);
      background: color-mix(in oklab, var(--bg) 85%, black 15%);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .container { width: min(1100px, 100%); margin: 0 auto; padding: 16px 20px; }
    .row { display: flex; gap: 12px; align-items: center; justify-content: space-between; }
    .brand { font-weight: 700; letter-spacing:.2px; }
    .btn {
      appearance: none; border: 1px solid rgba(255,255,255,.12);
      padding: 10px 14px; border-radius: 999px; background: #111827; color: var(--fg);
      box-shadow: var(--shadow); cursor: pointer; transition: .2s transform, .2s opacity, .2s background;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: var(--accent); border-color: transparent; color: white; }
    .btn.ghost { background: transparent; border-color: rgba(255,255,255,.18); }

    main { flex: 1; }
    .card {
      background: var(--card); border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px;
    }
    .grid { display: grid; gap: 16px; }
    .grid.cols-2 { grid-template-columns: 1fr 1fr; }
    @media (max-width: 860px) { .grid.cols-2 { grid-template-columns: 1fr; } }

    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="email"], input[type="datetime-local"], textarea, select {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12);
      background: #0b1220; color: var(--fg); outline: none; font: inherit;
    }
    textarea { min-height: 110px; resize: vertical; }

    .cover {
      position: relative; border-radius: var(--radius); overflow: hidden; border: 1px solid rgba(255,255,255,.1);
      min-height: 160px; display: grid; place-items: center; background: #0b1220;
    }
    .cover img { width: 100%; height: 280px; object-fit: cover; display: block; }

    .muted { color: var(--muted); }
    .stack { display:flex; flex-direction: column; gap: 10px; }
    .row-gap { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .chip { background: rgba(255,255,255,.08); color: var(--fg); padding: 6px 10px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(255,255,255,.12); }
    .list { display:flex; flex-direction: column; gap: 8px; }
    .flex { display:flex; }
    .between { justify-content: space-between; align-items: center; }
    .center { align-items: center; }

    .rsvp-btns { display:flex; gap:8px; flex-wrap: wrap; }
    .rsvp-btns .btn { padding: 8px 12px; border-radius: 12px; }

    .danger { color: #fecaca; }
    .success { color: #bbf7d0; }
    .warning { color: #fde68a; }

    .preview {
      --preview-bg: var(--bg);
      --preview-fg: var(--fg);
      --preview-font: var(--font);
      border-radius: var(--radius); overflow: hidden; border:1px solid rgba(255,255,255,.1);
    }
    .preview .hero { background: var(--preview-bg); color: var(--preview-fg); font-family: var(--preview-font);
      padding: 26px 22px; display:grid; gap: 6px; }
    .preview .title { font-size: clamp(26px, 4vw, 36px); font-weight: 800; }
    .preview .when { font-size: 14px; color: color-mix(in oklab, var(--preview-fg), black 30%); }

    .sr-only { position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .divider { height:1px; background: rgba(255,255,255,.08); margin: 8px 0 14px; }

    .toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
      background: #111827; color: var(--fg); border: 1px solid rgba(255,255,255,.14);
      padding: 10px 14px; border-radius: 999px; box-shadow: var(--shadow); opacity: 0; pointer-events: none; transition: .2s ease; }
    .toast.show { opacity: 1; }
  </style>
  <!-- Optional Firebase (fyll din config f√∂r molnlagring/RSVP i realtid). L√§mna tomt f√∂r lokalt l√§ge. -->
  <script type="module" id="firebase-loader">
    // Fyll i om du vill anv√§nda Firebase (annars k√∂r appen lokalt i webbl√§saren)
    window.FIREBASE_CONFIG = {
      apiKey: "",            // t.ex. "AIza..."
      authDomain: "",
      projectId: "",
      storageBucket: "",     // valfritt, f√∂r att ladda upp omslagsbilder senare
    };

    // F√∂rberedd dynamisk import: bara om API-nyckeln finns
    if (window.FIREBASE_CONFIG.apiKey) {
      try {
        const [{ initializeApp }, { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs }, { getStorage, ref, uploadString, getDownloadURL } ] = await Promise.all([
          import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'),
          import('https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js'),
        ]);
        const app = initializeApp(window.FIREBASE_CONFIG);
        window._firebase = {
          getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs,
          getStorage, ref, uploadString, getDownloadURL,
          app,
        };
      } catch (e) {
        console.warn('Firebase kunde inte laddas, k√∂r lokalt ist√§llet.', e);
      }
    }
  </script>
</head>
<body>
  <header>
    <div class="container row">
      <div class="brand">üéâ EventApp</div>
      <nav class="row" style="gap:8px">
        <button class="btn ghost" id="btn-home">Hem</button>
        <button class="btn primary" id="btn-new">Skapa event</button>
      </nav>
    </div>
  </header>

  <main class="container" id="app" aria-live="polite"></main>

  <template id="tpl-new">
    <section class="grid cols-2">
      <form class="card stack" id="new-form">
        <h2 style="margin:0">Skapa event</h2>
        <p class="muted" style="margin-top:-6px">Anpassa utseendet och fyll i detaljerna. * = obligatoriskt.</p>
        <div class="grid cols-2">
          <div>
            <label for="name">Eventnamn *</label>
            <input id="name" name="name" type="text" required placeholder="T.ex. Spelkv√§ll" />
          </div>
          <div>
            <label for="host">V√§rdens e‚Äëpost</label>
            <input id="host" name="host" type="email" placeholder="namn@exempel.se" />
          </div>
          <div>
            <label for="start">Start *</label>
            <input id="start" name="start" type="datetime-local" required />
          </div>
          <div>
            <label for="end">Slut *</label>
            <input id="end" name="end" type="datetime-local" required />
          </div>
        </div>
        <div>
          <label for="desc">Beskrivning *</label>
          <textarea id="desc" name="desc" required placeholder="Kort beskrivning, adress, vad man ska ta med osv."></textarea>
        </div>
        <div class="grid cols-2">
          <div>
            <label for="bg">Bakgrundsf√§rg</label>
            <input id="bg" name="bg" type="color" value="#0f172a" />
          </div>
          <div>
            <label for="fg">Textf√§rg</label>
            <input id="fg" name="fg" type="color" value="#e2e8f0" />
          </div>
          <div>
            <label for="font">Typsnitt</label>
            <select id="font" name="font">
              <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">Sans (system)</option>
              <option value="Georgia, 'Times New Roman', serif">Serif</option>
              <option value="'Courier New', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace">Monospace</option>
            </select>
          </div>
          <div>
            <label for="cover">Omslagsbild</label>
            <input id="cover" name="cover" type="file" accept="image/*" />
          </div>
        </div>
        <div class="row between">
          <div class="muted">Tips: Ladda upp en horisontell bild (ca 1200√ó600).</div>
          <button class="btn primary" type="submit">Skapa event</button>
        </div>
      </form>

      <div class="card stack">
        <h2 style="margin:0">F√∂rhandsvisning</h2>
        <div class="preview" id="preview">
          <div class="cover" id="preview-cover"><span class="muted">Ingen bild vald</span></div>
          <div class="hero">
            <div class="title" id="p-title">Eventnamn</div>
            <div class="when" id="p-when">Start ‚Äì Slut</div>
            <div id="p-desc" class="muted">Beskrivning...</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="stack">
          <div class="row-gap">
            <span class="chip">Dela l√§nken efter att du skapat eventet</span>
            <span class="chip">G√§ster kan svara: Ja / Nej / Kanske</span>
          </div>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-event">
    <article class="stack">
      <section class="preview" id="ev-preview">
        <div class="cover" id="ev-cover"></div>
        <div class="hero">
          <div class="title" id="ev-title"></div>
          <div class="when" id="ev-when"></div>
          <div id="ev-desc" class="muted"></div>
        </div>
      </section>

      <section class="grid cols-2">
        <div class="card stack" id="invite-box">
          <h3 style="margin:0">Bjud in</h3>
          <p class="muted" style="margin-top:-6px">Skicka e‚Äëpostinbjudningar eller kopiera eventl√§nken.</p>
          <label for="invite-emails">E‚Äëpost (komma‚Äëseparerade)</label>
          <input id="invite-emails" type="text" placeholder="exempel@ex.se, kompis@ex.se" />
          <div class="row-gap">
            <a class="btn" id="btn-mailto" href="#">√ñppna e‚Äëpostklient</a>
            <button class="btn ghost" id="btn-copy">Kopiera l√§nk</button>
          </div>
          <div class="divider"></div>
          <small class="muted">Obs: Utan server skickas mejl via din egen klient (mailto:). Du kan ocks√• klistra in l√§nken var du vill.</small>
        </div>

        <div class="card stack">
          <h3 style="margin:0">RSVP</h3>
          <p class="muted" style="margin-top:-6px">Svara om du kan komma och se g√§stlistan nedan.</p>
          <div class="grid cols-2">
            <div>
              <label for="my-name">Ditt namn</label>
              <input id="my-name" type="text" placeholder="F√∂r- & efternamn" />
            </div>
            <div>
              <label for="my-email">Din e‚Äëpost</label>
              <input id="my-email" type="email" placeholder="namn@exempel.se" />
            </div>
          </div>
          <div class="rsvp-btns">
            <button class="btn" data-rsvp="yes">Ja</button>
            <button class="btn" data-rsvp="maybe">Kanske</button>
            <button class="btn" data-rsvp="no">Nej</button>
          </div>
        </div>
      </section>

      <section class="card stack">
        <div class="row between center">
          <h3 style="margin:0">G√§stlista</h3>
          <div class="row-gap">
            <span class="chip" id="count-yes">Ja: 0</span>
            <span class="chip" id="count-maybe">Kanske: 0</span>
            <span class="chip" id="count-no">Nej: 0</span>
          </div>
        </div>
        <div id="guest-list" class="list"></div>
      </section>

      <section class="row between">
        <div class="muted" id="owner-hint" hidden>Du skapade detta event. <button class="btn ghost" id="btn-edit">Redigera</button></div>
        <button class="btn ghost" id="btn-back">‚Üê Tillbaka</button>
      </section>

      <section class="card stack" id="edit-panel" hidden>
        <h3 style="margin:0">Redigera event</h3>
        <div class="grid cols-2">
          <div>
            <label>Eventnamn</label>
            <input id="e-name" type="text" />
          </div>
          <div>
            <label>V√§rdens e‚Äëpost</label>
            <input id="e-host" type="email" />
          </div>
          <div>
            <label>Start</label>
            <input id="e-start" type="datetime-local" />
          </div>
          <div>
            <label>Slut</label>
            <input id="e-end" type="datetime-local" />
          </div>
        </div>
        <div>
          <label>Beskrivning</label>
          <textarea id="e-desc"></textarea>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Bakgrundsf√§rg</label>
            <input id="e-bg" type="color" />
          </div>
          <div>
            <label>Textf√§rg</label>
            <input id="e-fg" type="color" />
          </div>
          <div>
            <label>Typsnitt</label>
            <select id="e-font">
              <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">Sans (system)</option>
              <option value="Georgia, 'Times New Roman', serif">Serif</option>
              <option value="'Courier New', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace">Monospace</option>
            </select>
          </div>
          <div>
            <label>Omslagsbild</label>
            <input id="e-cover" type="file" accept="image/*" />
          </div>
        </div>
        <div class="row between">
          <span class="muted">Spara dina √§ndringar</span>
          <button class="btn primary" id="btn-save">Spara</button>
        </div>
      </section>
    </article>
  </template>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    const qs = (sel, el=document) => el.querySelector(sel);
    const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const fmtDateRange = (startISO, endISO) => {
      try {
        const s = new Date(startISO);
        const e = new Date(endISO);
        const sStr = s.toLocaleString('sv-SE', { dateStyle:'medium', timeStyle:'short' });
        const eStr = e.toLocaleString('sv-SE', { dateStyle:'medium', timeStyle:'short' });
        return `${sStr} ‚Äì ${eStr}`;
      } catch { return `${startISO} ‚Äì ${endISO}` }
    };

    const id = () => crypto.getRandomValues(new Uint32Array(1))[0].toString(36);

    const readFileDataURL = (file) => new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onerror = rej; fr.onload = () => res(fr.result); fr.readAsDataURL(file);
    });

    const toast = (msg) => {
      const t = qs('#toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1400);
    };

    // --- Lagring (lokal eller Firebase) ---
    const LocalStore = {
      mode: 'local',
      async createEvent(data) {
        const eid = id();
        localStorage.setItem(`event:${eid}`, JSON.stringify({ ...data, id: eid, createdAt: Date.now(), updatedAt: Date.now() }));
        return eid;
      },
      async getEvent(eid) {
        const raw = localStorage.getItem(`event:${eid}`);
        return raw ? JSON.parse(raw) : null;
      },
      async updateEvent(eid, data) {
        const curr = await this.getEvent(eid);
        if (!curr) return;
        localStorage.setItem(`event:${eid}`, JSON.stringify({ ...curr, ...data, id: eid, updatedAt: Date.now() }));
      },
      async addOrUpdateRSVP(eid, email, name, status) {
        const key = `rsvps:${eid}`;
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        const idx = list.findIndex(x => x.email === email);
        const entry = { email, name, status, ts: Date.now() };
        if (idx >= 0) list[idx] = entry; else list.push(entry);
        localStorage.setItem(key, JSON.stringify(list));
        // pinga andra flikar via storage-event indirekt
      },
      async getRSVPs(eid) {
        return JSON.parse(localStorage.getItem(`rsvps:${eid}`) || '[]');
      },
      subscribeRSVPs(eid, cb) {
        const onStorage = (e) => { if (e.key === `rsvps:${eid}`) cb(JSON.parse(e.newValue || '[]')); };
        window.addEventListener('storage', onStorage);
        return () => window.removeEventListener('storage', onStorage);
      }
    };

    const FirebaseStore = {
      mode: 'firebase',
      get _ok() { return !!window._firebase; },
      get db() { return window._firebase?.getFirestore(window._firebase.app); },
      async createEvent(data) {
        const eid = id();
        const { setDoc, doc } = window._firebase;
        await setDoc(doc(this.db, 'events', eid), { ...data, id: eid, createdAt: Date.now(), updatedAt: Date.now() });
        return eid;
      },
      async getEvent(eid) {
        const { getDoc, doc } = window._firebase;
        const snap = await getDoc(doc(this.db, 'events', eid));
        return snap.exists() ? snap.data() : null;
      },
      async updateEvent(eid, data) {
        const { updateDoc, doc } = window._firebase;
        await updateDoc(doc(this.db, 'events', eid), { ...data, updatedAt: Date.now() });
      },
      async addOrUpdateRSVP(eid, email, name, status) {
        const { setDoc, doc } = window._firebase;
        const safeId = email.replace(/\./g, ',');
        await setDoc(doc(this.db, 'events', eid, 'rsvps', safeId), {
          email, name, status, ts: Date.now()
        });
      },
      async getRSVPs(eid) {
        const { getDocs, collection } = window._firebase;
        const q = collection(this.db, 'events', eid, 'rsvps');
        const snap = await getDocs(q);
        return snap.docs.map(d => d.data());
      },
      subscribeRSVPs(eid, cb) {
        const { onSnapshot, collection } = window._firebase;
        const q = collection(this.db, 'events', eid, 'rsvps');
        const unsub = onSnapshot(q, (snap) => {
          cb(snap.docs.map(d => d.data()));
        });
        return unsub;
      }
    };

    const Store = (window._firebase ? FirebaseStore : LocalStore);

    // --- Router ---
    const routes = {
      '': () => showNew(),
      '#/new': () => showNew(),
      '#/event': (parts) => showEvent(parts[2])
    };

    function route() {
      const h = location.hash || '#/new';
      const parts = h.split('/');
      const key = parts.length > 2 ? `#/event` : h;
      (routes[key] || routes['']) (parts);
    }

    // --- View: New Event ---
    async function showNew() {
      const app = qs('#app');
      app.innerHTML = '';
      const tpl = qs('#tpl-new');
      const view = tpl.content.cloneNode(true);
      app.appendChild(view);

      const $ = (sel) => qs(sel, app);
      const preview = $('#preview');
      const coverBox = $('#preview-cover');

      const syncPreview = () => {
        const name = $('#name').value || 'Eventnamn';
        const desc = $('#desc').value || 'Beskrivning...';
        const start = $('#start').value; const end = $('#end').value;
        const when = (start && end) ? fmtDateRange(start, end) : 'Start ‚Äì Slut';
        const bg = $('#bg').value; const fg = $('#fg').value; const font = $('#font').value;

        preview.style.setProperty('--preview-bg', bg);
        preview.style.setProperty('--preview-fg', fg);
        preview.style.setProperty('--preview-font', font);
        $('#p-title').textContent = name;
        $('#p-when').textContent = when;
        $('#p-desc').textContent = desc;
      };

      qsa('#new-form input, #new-form textarea, #new-form select', app).forEach(el => el.addEventListener('input', syncPreview));

      qs('#cover', app).addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f) return; const url = await readFileDataURL(f);
        coverBox.innerHTML = `<img alt="Omslagsbild" src="${url}">`;
      });

      syncPreview();

      qs('#new-form', app).addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = $('#name').value.trim();
        const start = $('#start').value; const end = $('#end').value;
        const desc = $('#desc').value.trim();
        if (!name || !start || !end || !desc) { toast('Fyll i alla obligatoriska f√§lt'); return; }
        if (new Date(end) < new Date(start)) { toast('Sluttiden kan inte vara f√∂re start'); return; }
        const host = $('#host').value.trim();
        const bg = $('#bg').value; const fg = $('#fg').value; const font = $('#font').value;
        const coverInput = qs('#cover', app);
        let coverData = '';
        if (coverInput.files?.[0]) coverData = await readFileDataURL(coverInput.files[0]);

        const data = { name, startISO: start, endISO: end, description: desc, hostEmail: host,
          styles: { bg, fg, font }, coverData };
        const eid = await Store.createEvent(data);
        localStorage.setItem(`owner:${eid}`, '1');
        location.hash = `#/event/${eid}`;
        toast('Event skapat!');
      });

      qs('#btn-home').onclick = () => location.hash = '#/new';
      qs('#btn-new').onclick = () => location.hash = '#/new';
    }

    // --- View: Event ---
    async function showEvent(eid) {
      const app = qs('#app');
      app.innerHTML = '';
      const tpl = qs('#tpl-event');
      const view = tpl.content.cloneNode(true);
      app.appendChild(view);
      const $ = (sel) => qs(sel, app);

      const ev = await Store.getEvent(eid);
      if (!ev) {
        app.innerHTML = `<div class="card"><h3>Event hittades inte</h3><p class="muted">L√§nken kan vara fel eller s√• har eventet raderats (lokalt l√§ge).</p><div class="row"><button class="btn" onclick="location.hash='#/new'">Skapa nytt</button></div></div>`;
        return;
      }

      // Apply preview styles
      const prev = $('#ev-preview');
      prev.style.setProperty('--preview-bg', ev.styles?.bg || '#0f172a');
      prev.style.setProperty('--preview-fg', ev.styles?.fg || '#e2e8f0');
      prev.style.setProperty('--preview-font', ev.styles?.font || 'system-ui');

      $('#ev-title').textContent = ev.name;
      $('#ev-when').textContent = fmtDateRange(ev.startISO, ev.endISO);
      $('#ev-desc').textContent = ev.description;

      const cover = $('#ev-cover');
      cover.innerHTML = ev.coverData ? `<img alt="Omslagsbild" src="${ev.coverData}"/>` : `<span class="muted">Ingen bild</span>`;

      // Invite panel
      const link = location.origin + location.pathname + `#/event/${eid}`;
      $('#btn-copy').addEventListener('click', async () => { await navigator.clipboard.writeText(link); toast('L√§nk kopierad'); });
      const subject = encodeURIComponent(`Inbjudan: ${ev.name}`);
      const body = encodeURIComponent(`${ev.name}\n${fmtDateRange(ev.startISO, ev.endISO)}\n\n${ev.description}\n\nOSA i l√§nken: ${link}`);
      $('#btn-mailto').href = `mailto:${encodeURIComponent(ev.hostEmail || '')}?subject=${subject}&body=${body}`;

      // RSVP handling
      const applyCounts = (list) => {
        const yes = list.filter(x => x.status === 'yes').length;
        const maybe = list.filter(x => x.status === 'maybe').length;
        const no = list.filter(x => x.status === 'no').length;
        $('#count-yes').textContent = `Ja: ${yes}`;
        $('#count-maybe').textContent = `Kanske: ${maybe}`;
        $('#count-no').textContent = `Nej: ${no}`;
      };

      const renderGuests = (list) => {
        const box = $('#guest-list');
        box.innerHTML = '';
        const row = (g) => `<div class="row between"><div>${g.name || 'Ok√§nd'} <span class="muted">&lt;${g.email}&gt;</span></div><div>${g.status === 'yes' ? '‚úÖ' : g.status === 'maybe' ? 'ü§î' : '‚ùå'}</div></div>`;
        list.sort((a,b) => (a.status+'_'+a.name).localeCompare(b.status+'_'+b.name));
        list.forEach(g => { const d = document.createElement('div'); d.innerHTML = row(g); box.appendChild(d); });
      };

      const list = await Store.getRSVPs(eid);
      applyCounts(list); renderGuests(list);

      const unsub = Store.subscribeRSVPs(eid, (list) => { applyCounts(list); renderGuests(list); });
      window.addEventListener('beforeunload', () => unsub && unsub());

      const meName = localStorage.getItem('me:name') || '';
      const meEmail = localStorage.getItem('me:email') || '';
      $('#my-name').value = meName; $('#my-email').value = meEmail;

      qsa('[data-rsvp]', app).forEach(btn => btn.addEventListener('click', async () => {
        const name = $('#my-name').value.trim();
        const email = $('#my-email').value.trim();
        if (!email) { toast('Fyll i din e‚Äëpost'); return; }
        localStorage.setItem('me:name', name); localStorage.setItem('me:email', email);
        const status = btn.getAttribute('data-rsvp');
        await Store.addOrUpdateRSVP(eid, email, name, status);
        toast('Svar skickat');
        const list = await Store.getRSVPs(eid); applyCounts(list); renderGuests(list);
      }));

      // Owner-only edit (om du skapade eventet i denna webbl√§sare)
      const owner = localStorage.getItem(`owner:${eid}`) === '1';
      const ownerHint = $('#owner-hint');
      if (owner) ownerHint.hidden = false;

      $('#btn-back').onclick = () => history.back();
      $('#btn-edit').onclick = () => {
        const p = qs('#edit-panel', app); p.hidden = !p.hidden;
        if (!p.hidden) fillEditForm();
      };
      $('#btn-save').onclick = saveEdits;

      function fillEditForm() {
        qs('#e-name', app).value = ev.name;
        qs('#e-host', app).value = ev.hostEmail || '';
        qs('#e-start', app).value = ev.startISO;
        qs('#e-end', app).value = ev.endISO;
        qs('#e-desc', app).value = ev.description;
        qs('#e-bg', app).value = ev.styles?.bg || '#0f172a';
        qs('#e-fg', app).value = ev.styles?.fg || '#e2e8f0';
        qs('#e-font', app).value = ev.styles?.font || 'system-ui';
      }

      async function saveEdits() {
        const data = {
          name: qs('#e-name', app).value.trim(),
          hostEmail: qs('#e-host', app).value.trim(),
          startISO: qs('#e-start', app).value,
          endISO: qs('#e-end', app).value,
          description: qs('#e-desc', app).value.trim(),
          styles: {
            bg: qs('#e-bg', app).value,
            fg: qs('#e-fg', app).value,
            font: qs('#e-font', app).value,
          }
        };
        const f = qs('#e-cover', app).files?.[0];
        if (f) data.coverData = await readFileDataURL(f);
        await Store.updateEvent(eid, data);
        Object.assign(ev, data);
        toast('Sparat');
        showEvent(eid); // re-render
      }
    }

    // Bind header buttons
    qs('#btn-home').onclick = () => location.hash = '#/new';
    qs('#btn-new').onclick = () => location.hash = '#/new';

    window.addEventListener('hashchange', route);
    route();
  </script>
</body>
</html>
