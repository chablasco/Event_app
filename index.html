<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EventApp – Create & Share Events – by Cha Blasco</title>
  <!-- Google Font: Bricolage Grotesque for brand/title -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;       /* default background (white) */
      --fg: #000000;       /* default text (black) */
      --card: color-mix(in oklab, var(--bg) 85%, black 15%);
      --muted: #475569;    /* slate-600-ish for light bg */
      --accent: #2563eb;   /* blue-600 */
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.15);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg); font-family: var(--font);
      display: flex; flex-direction: column; min-height: 100vh;
    }
    header {
      position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px);
      background: color-mix(in oklab, var(--bg) 85%, black 15%);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .container { width: min(1100px, 100%); margin: 0 auto; padding: 16px 20px; }
    .row { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .brand { font-family: 'Bricolage Grotesque', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size: 18px; letter-spacing:.2px; font-weight: 700; }
    
    .brand a { color: inherit; text-decoration: underline; text-underline-offset: 3px; }
    .btn {
      appearance: none; border: 1px solid color-mix(in oklab, var(--fg) 20%, transparent);
      padding: 10px 14px; border-radius: 999px; background: color-mix(in oklab, var(--bg) 90%, black 10%); color: var(--fg);
      box-shadow: var(--shadow); cursor: pointer; transition: .2s transform, .2s opacity, .2s background;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: var(--accent); border-color: transparent; color: white; }
    .btn.ghost { background: transparent; border-color: color-mix(in oklab, var(--fg) 25%, transparent); }

    main { flex: 1; }
    .card {
      background: var(--card); border: 1px solid rgba(0,0,0,.08);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px;
    }
    .grid { display: grid; gap: 16px; }
    .grid.cols-2 { grid-template-columns: 1fr 1fr; }
    @media (max-width: 860px) { .grid.cols-2 { grid-template-columns: 1fr; } }

    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="email"], input[type="datetime-local"], textarea, select {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.12);
      background: color-mix(in oklab, var(--bg) 96%, black 4%); color: var(--fg); outline: none; font: inherit;
    }
    textarea { min-height: 110px; resize: vertical; }

    .cover {
      position: relative; border-radius: var(--radius); overflow: hidden; border: 1px solid rgba(0,0,0,.1);
      min-height: 160px; display: grid; place-items: center; background: color-mix(in oklab, var(--bg) 96%, black 4%);
    }
    .cover img { width: 100%; height: 280px; object-fit: cover; display: block; }

    .muted { color: var(--muted); }
    .stack { display:flex; flex-direction: column; gap: 10px; }
    .row-gap { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .chip { background: rgba(0,0,0,.04); color: var(--fg); padding: 6px 10px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(0,0,0,.08); }
    .list { display:flex; flex-direction: column; gap: 8px; }
    .flex { display:flex; }
    .between { justify-content: space-between; align-items: center; }
    .center { align-items: center; }

    .rsvp-btns { display:flex; gap:8px; flex-wrap: wrap; }
    .rsvp-btns .btn { padding: 8px 12px; border-radius: 12px; }

    .danger { color: #dc2626; }
    .success { color: #16a34a; }
    .warning { color: #ca8a04; }

    .preview { --preview-bg: var(--bg); --preview-fg: var(--fg); --preview-font: var(--font);
      border-radius: var(--radius); overflow: hidden; border:1px solid rgba(0,0,0,.1);
    }
    .preview .hero { background: var(--preview-bg); color: var(--preview-fg); font-family: var(--preview-font);
      padding: 26px 22px; display:grid; gap: 6px; }
    .preview .title { font-size: clamp(26px, 4vw, 36px); font-weight: 800; }
    /* Presentation view title uses Bricolage Grotesque */
    
    .preview .when { font-size: 14px; color: color-mix(in oklab, var(--preview-fg), black 30%); }

    .sr-only { position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .divider { height:1px; background: rgba(0,0,0,.08); margin: 8px 0 14px; }

    .toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
      background: color-mix(in oklab, var(--bg) 92%, black 8%); color: var(--fg);
      border: 1px solid rgba(0,0,0,.14);
      padding: 10px 14px; border-radius: 999px; box-shadow: var(--shadow); opacity: 0; pointer-events: none; transition: .2s ease; }
    .toast.show { opacity: 1; }
  </style>

  <!-- Optional Firebase (fill your config for cloud storage/real-time RSVP). Leave empty to run locally. -->
  <script type="module" id="firebase-loader">
    // Fill in if you want to use Firebase (otherwise, the app runs locally in the browser)
    window.FIREBASE_CONFIG = {
      apiKey: "",            // e.g. "AIza..."
      authDomain: "",
      projectId: "",
      storageBucket: "",     // optional, for uploading cover images later
    };

    if (window.FIREBASE_CONFIG.apiKey) {
      try {
        const [{ initializeApp }, { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs }, { getStorage, ref, uploadString, getDownloadURL } ] = await Promise.all([
          import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'),
          import('https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js'),
        ]);
        const app = initializeApp(window.FIREBASE_CONFIG);
        window._firebase = {
          getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs,
          getStorage, ref, uploadString, getDownloadURL,
          app,
        };
      } catch (e) {
        console.warn('Firebase failed to load, running locally instead.', e);
      }
    }
  </script>
</head>
<body>
  <header>
    <div class="container row">
      <div class="brand">EventApp – Create & Share Events – by <a href="https://www.chablasco.com" target="_blank" rel="noopener">Cha Blasco</a></div>
      <nav class="row" style="gap:8px">
        <button class="btn ghost" id="btn-home">My events</button>
        <button class="btn primary" id="btn-new">Create event</button>
      </nav>
    </div>
  </header>

  <main class="container" id="app" aria-live="polite"></main>

  <!-- LIST VIEW -->
  <template id="tpl-list">
    <section class="stack">
      <div class="row between center">
        <h2 style="margin:0">My events</h2>
        <button class="btn primary" id="go-new">Create new</button>
      </div>
      <div id="list-box" class="grid"></div>
      <p class="muted" id="list-hint"></p>
    </section>
  </template>

  <!-- NEW EVENT VIEW -->
  <template id="tpl-new">
    <section class="grid cols-2">
      <form class="card stack" id="new-form">
        <h2 style="margin:0">Create event</h2>
        <p class="muted" style="margin-top:-6px">Customize the look and fill in the details. * = required.</p>
        <div class="grid cols-2">
          <div>
            <label for="name">Event name *</label>
            <input id="name" name="name" type="text" required placeholder="e.g. Game Night" />
          </div>
          <div>
            <label for="host">Host email</label>
            <input id="host" name="host" type="email" placeholder="name@example.com" />
          </div>
          <div>
            <label for="start">Starts *</label>
            <input id="start" name="start" type="datetime-local" required />
          </div>
          <div>
            <label for="end">Ends *</label>
            <input id="end" name="end" type="datetime-local" required />
          </div>
        </div>
        <div>
          <label for="desc">Description *</label>
          <textarea id="desc" name="desc" required placeholder="Brief description, address, what to bring, etc."></textarea>
        </div>
        <div class="grid cols-2">
          <div>
            <label for="bg">Background color</label>
            <input id="bg" name="bg" type="color" value="#ffffff" />
          </div>
          <div>
            <label for="fg">Text color</label>
            <input id="fg" name="fg" type="color" value="#000000" />
          </div>
          <div>
            <label for="font">Font</label>
            <select id="font" name="font">
              <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">Sans (system)</option>
              <option value="Georgia, 'Times New Roman', serif">Serif</option>
              <option value="'Courier New', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace">Monospace</option>
            </select>
          </div>
          <div>
            <label for="cover">Cover image</label>
            <input id="cover" name="cover" type="file" accept="image/*" />
          </div>
        </div>
        <div class="row between">
          <div class="muted">Tip: Use a horizontal image (~1200×600).</div>
          <button class="btn primary" type="submit">Create</button>
        </div>
      </form>

      <div class="card stack">
        <h2 style="margin:0">Preview</h2>
        <div class="preview" id="preview">
          <div class="cover" id="preview-cover"><span class="muted">No image selected</span></div>
          <div class="hero">
            <div class="title" id="p-title">Event name</div>
            <div class="when" id="p-when">Start – End</div>
            <div id="p-desc" class="muted">Description...</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="stack">
          <div class="row-gap">
            <span class="chip">Share the link after creating the event</span>
            <span class="chip">Guests can reply: Yes / No / Maybe</span>
          </div>
        </div>
      </div>
    </section>
  </template>

  <!-- EVENT VIEW -->
  <template id="tpl-event">
    <article class="stack">
      <section class="preview" id="ev-preview">
        <div class="cover" id="ev-cover"></div>
        <div class="hero">
          <div class="title" id="ev-title"></div>
          <div class="when" id="ev-when"></div>
          <div id="ev-desc" class="muted"></div>
        </div>
      </section>

      <section class="grid cols-2">
        <div class="card stack" id="invite-box">
          <h3 style="margin:0">Invite</h3>
          <p class="muted" style="margin-top:-6px">Send email invites or copy the event link.</p>
          <label for="invite-emails">Emails (comma-separated)</label>
          <input id="invite-emails" type="text" placeholder="friend@example.com, buddy@example.com" />
          <div class="row-gap">
            <a class="btn" id="btn-mailto" href="#">Open email client</a>
            <button class="btn ghost" id="btn-copy">Copy link</button>
          </div>
          <div class="divider"></div>
          <small class="muted">Note: Without a server, emails are sent via your own client (mailto:). You can also paste the link anywhere.</small>
        </div>

        <div class="card stack">
          <h3 style="margin:0">RSVP</h3>
          <p class="muted" style="margin-top:-6px">Respond if you can come and see the guest list below.</p>
          <div class="grid cols-2">
            <div>
              <label for="my-name">Your name</label>
              <input id="my-name" type="text" placeholder="First & last name" />
            </div>
            <div>
              <label for="my-email">Your email</label>
              <input id="my-email" type="email" placeholder="name@example.com" />
            </div>
          </div>
          <div class="rsvp-btns">
            <button class="btn" data-rsvp="yes">Yes</button>
            <button class="btn" data-rsvp="maybe">Maybe</button>
            <button class="btn" data-rsvp="no">No</button>
          </div>
        </div>
      </section>

      <section class="card stack">
        <div class="row between center">
          <h3 style="margin:0">Guest list</h3>
          <div class="row-gap">
            <span class="chip" id="count-yes">Yes: 0</span>
            <span class="chip" id="count-maybe">Maybe: 0</span>
            <span class="chip" id="count-no">No: 0</span>
          </div>
        </div>
        <div id="guest-list" class="list"></div>
      </section>

      <section class="row between">
        <div class="muted" id="owner-hint" hidden>You created this event. <button class="btn ghost" id="btn-edit">Edit</button></div>
        <button class="btn ghost" id="btn-back">← Back</button>
      </section>

      <section class="card stack" id="edit-panel" hidden>
        <h3 style="margin:0">Edit event</h3>
        <div class="grid cols-2">
          <div>
            <label>Event name</label>
            <input id="e-name" type="text" />
          </div>
          <div>
            <label>Host email</label>
            <input id="e-host" type="email" />
          </div>
          <div>
            <label>Starts</label>
            <input id="e-start" type="datetime-local" />
          </div>
          <div>
            <label>Ends</label>
            <input id="e-end" type="datetime-local" />
          </div>
        </div>
        <div>
          <label>Description</label>
          <textarea id="e-desc"></textarea>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Background color</label>
            <input id="e-bg" type="color" />
          </div>
          <div>
            <label>Text color</label>
            <input id="e-fg" type="color" />
          </div>
          <div>
            <label>Font</label>
            <select id="e-font">
              <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">Sans (system)</option>
              <option value="Georgia, 'Times New Roman', serif">Serif</option>
              <option value="'Courier New', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace">Monospace</option>
            </select>
          </div>
          <div>
            <label>Cover image</label>
            <input id="e-cover" type="file" accept="image/*" />
          </div>
        </div>
        <div class="row between">
          <span class="muted">Save your changes</span>
          <button class="btn primary" id="btn-save">Save</button>
        </div>
      </section>
    </article>
  </template>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    const qs = (sel, el=document) => el.querySelector(sel);
    const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const DEFAULT_THEME = { bg:'#ffffff', fg:'#000000', font: "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'" };

    const setTheme = ({bg, fg, font}) => {
      const root = document.documentElement;
      if (bg) root.style.setProperty('--bg', bg);
      if (fg) root.style.setProperty('--fg', fg);
      if (font) root.style.setProperty('--font', font);
    };

    const resetTheme = () => setTheme(DEFAULT_THEME);

    const fmtDateRange = (startISO, endISO) => {
      try {
        const s = new Date(startISO);
        const e = new Date(endISO);
        const sStr = s.toLocaleString('en-GB', { dateStyle:'medium', timeStyle:'short' });
        const eStr = e.toLocaleString('en-GB', { dateStyle:'medium', timeStyle:'short' });
        return `${sStr} – ${eStr}`;
      } catch { return `${startISO} – ${endISO}` }
    };

    const id = () => crypto.getRandomValues(new Uint32Array(1))[0].toString(36);

    const readFileDataURL = (file) => new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onerror = rej; fr.onload = () => res(fr.result); fr.readAsDataURL(file);
    });

    const toast = (msg) => {
      const t = qs('#toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1400);
    };

    // --- Storage (local or Firebase) ---
    const LocalStore = {
      mode: 'local',
      async createEvent(data) {
        const eid = id();
        localStorage.setItem(`event:${eid}`, JSON.stringify({ ...data, id: eid, createdAt: Date.now(), updatedAt: Date.now() }));
        return eid;
      },
      async getEvent(eid) {
        const raw = localStorage.getItem(`event:${eid}`);
        return raw ? JSON.parse(raw) : null;
      },
      async updateEvent(eid, data) {
        const curr = await this.getEvent(eid);
        if (!curr) return;
        const merged = { ...curr, ...data, id: eid, updatedAt: Date.now() };
        localStorage.setItem(`event:${eid}`, JSON.stringify(merged));
      },
      async addOrUpdateRSVP(eid, email, name, status) {
        const key = `rsvps:${eid}`;
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        const idx = list.findIndex(x => x.email === email);
        const entry = { email, name, status, ts: Date.now() };
        if (idx >= 0) list[idx] = entry; else list.push(entry);
        localStorage.setItem(key, JSON.stringify(list));
      },
      async getRSVPs(eid) {
        return JSON.parse(localStorage.getItem(`rsvps:${eid}`) || '[]');
      },
      subscribeRSVPs(eid, cb) {
        const onStorage = (e) => { if (e.key === `rsvps:${eid}`) cb(JSON.parse(e.newValue || '[]')); };
        window.addEventListener('storage', onStorage);
        return () => window.removeEventListener('storage', onStorage);
      },
      listEvents() {
        const out = [];
        for (let i=0;i<localStorage.length;i++) {
          const k = localStorage.key(i);
          if (k && k.startsWith('event:')) {
            try { const ev = JSON.parse(localStorage.getItem(k)); if (ev?.id) out.push(ev); } catch {}
          }
        }
        return out.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
      }
    };

    const FirebaseStore = {
      mode: 'firebase',
      get _ok() { return !!window._firebase; },
      get db() { return window._firebase?.getFirestore(window._firebase.app); },
      async createEvent(data) {
        const eid = id();
        const { setDoc, doc } = window._firebase;
        await setDoc(doc(this.db, 'events', eid), { ...data, id: eid, createdAt: Date.now(), updatedAt: Date.now() });
        return eid;
      },
      async getEvent(eid) {
        const { getDoc, doc } = window._firebase;
        const snap = await getDoc(doc(this.db, 'events', eid));
        return snap.exists() ? snap.data() : null;
      },
      async updateEvent(eid, data) {
        const { updateDoc, doc } = window._firebase;
        await updateDoc(doc(this.db, 'events', eid), { ...data, updatedAt: Date.now() });
      },
      async addOrUpdateRSVP(eid, email, name, status) {
        const { setDoc, doc } = window._firebase;
        const safeId = email.replace(/\./g, ',');
        await setDoc(doc(this.db, 'events', eid, 'rsvps', safeId), { email, name, status, ts: Date.now() });
      },
      async getRSVPs(eid) {
        const { getDocs, collection } = window._firebase;
        const q = collection(this.db, 'events', eid, 'rsvps');
        const snap = await getDocs(q);
        return snap.docs.map(d => d.data());
      },
      subscribeRSVPs(eid, cb) {
        const { onSnapshot, collection } = window._firebase;
        const q = collection(this.db, 'events', eid, 'rsvps');
        const unsub = onSnapshot(q, (snap) => { cb(snap.docs.map(d => d.data())); });
        return unsub;
      },
      listEvents() {
        // For simplicity, listing is only implemented for local mode in this demo.
        return [];
      }
    };

    const Store = (window._firebase ? FirebaseStore : LocalStore);

    // --- Router ---
    const routes = {
      '': () => showList(),
      '#/events': () => showList(),
      '#/new': () => showNew(),
      '#/event': (parts) => showEvent(parts[2])
    };

    function route() {
      const h = location.hash || '#/events';
      const parts = h.split('/');
      const key = parts.length > 2 ? '#/event' : h;
      (routes[key] || routes['']) (parts);
    }

    // --- View: List (trackable events index) ---
    function showList() {
      resetTheme();
      const app = qs('#app');
      app.innerHTML = '';
      const tpl = qs('#tpl-list');
      const view = tpl.content.cloneNode(true);
      app.appendChild(view);

      const box = qs('#list-box', app);
      const items = Store.listEvents();
      if (items.length === 0) {
        qs('#list-hint', app).textContent = 'No local events yet. Create one to get a unique link you can revisit.';
      } else {
        box.classList.add('grid','cols-2');
        items.forEach(ev => {
          const link = location.origin + location.pathname + '#/event/' + ev.id;
          const card = document.createElement('div');
          card.className = 'card stack';
          card.innerHTML = `
            <div class="preview ev-preview">
              <div class="cover">${ev.coverData ? `<img alt="Cover image" src="${ev.coverData}"/>` : `<span class=\"muted\">No image</span>`}</div>
              <div class="hero">
                <div class="title">${ev.name}</div>
                <div class="when">${fmtDateRange(ev.startISO, ev.endISO)}</div>
                <div class="muted">${(ev.description||'')}</div>
              </div>
            </div>
            <div class="row between center">
              <a class="btn" href="#/event/${ev.id}">Open</a>
              <button class="btn ghost copy" data-link="${link}">Copy link</button>
            </div>
            <small class="muted">URL: <code>${link}</code></small>
          `;
          box.appendChild(card);
          const prev = card.querySelector('.ev-preview');
          prev.style.setProperty('--preview-bg', ev.styles?.bg || DEFAULT_THEME.bg);
          prev.style.setProperty('--preview-fg', ev.styles?.fg || DEFAULT_THEME.fg);
          prev.style.setProperty('--preview-font', ev.styles?.font || DEFAULT_THEME.font);
        });

        qsa('.copy', box).forEach(btn => btn.addEventListener('click', async (e) => {
          const l = e.currentTarget.getAttribute('data-link');
          await navigator.clipboard.writeText(l);
          toast('Link copied');
        }));
      }
      const newBtn = qs('#go-new', app);
      if (newBtn) newBtn.onclick = () => location.hash = '#/new';
      qs('#btn-home').onclick = () => location.hash = '#/events';
      qs('#btn-new').onclick = () => location.hash = '#/new';
    } else {
        box.classList.add('grid','cols-2');
        items.forEach(ev => {
          const link = location.origin + location.pathname + '#/event/' + ev.id;
          const card = document.createElement('div');
          card.className = 'card stack';
          card.innerHTML = `
            <div class="preview ev-preview">
              <div class="cover">${ev.coverData ? `<img alt="Cover image" src="${ev.coverData}"/>` : `<span class=\"muted\">No image</span>`}</div>
              <div class="hero">
                <div class="title">${ev.name}</div>
                <div class="when">${fmtDateRange(ev.startISO, ev.endISO)}</div>
                <div class="muted">${(ev.description||'')}</div>
              </div>
            </div>
            <div class="row between center">
              <a class="btn" href="#/event/${ev.id}">Open</a>
              <button class="btn ghost copy" data-link="${link}">Copy link</button>
            </div>
            <small class="muted">URL: <code>${link}</code></small>
          `;
          box.appendChild(card);
          // Apply per-card theme to the preview block
          const prev = card.querySelector('.ev-preview');
          prev.style.setProperty('--preview-bg', ev.styles?.bg || DEFAULT_THEME.bg);
          prev.style.setProperty('--preview-fg', ev.styles?.fg || DEFAULT_THEME.fg);
          prev.style.setProperty('--preview-font', ev.styles?.font || DEFAULT_THEME.font);
        });

        // Copy handlers
        qsa('.copy', box).forEach(btn => btn.addEventListener('click', async (e) => {
          const l = e.currentTarget.getAttribute('data-link');
          await navigator.clipboard.writeText(l);
          toast('Link copied');
        }));
      }
      qs('#btn-home').onclick = () => location.hash = '#/events';
      qs('#btn-new').onclick = () => location.hash = '#/new';
    }

    // --- View: New Event ---
    async function showNew() {
      resetTheme();
      const app = qs('#app');
      app.innerHTML = '';
      const tpl = qs('#tpl-new');
      const view = tpl.content.cloneNode(true);
      app.appendChild(view);

      const $ = (sel) => qs(sel, app);
      const preview = $('#preview');
      const coverBox = $('#preview-cover');

      const syncPreview = () => {
        const name = $('#name').value || 'Event name';
        const desc = $('#desc').value || 'Description...';
        const start = $('#start').value; const end = $('#end').value;
        const when = (start && end) ? fmtDateRange(start, end) : 'Start – End';
        const bg = $('#bg').value; const fg = $('#fg').value; const font = $('#font').value;

        preview.style.setProperty('--preview-bg', bg);
        preview.style.setProperty('--preview-fg', fg);
        preview.style.setProperty('--preview-font', font);
        $('#p-title').textContent = name;
        $('#p-when').textContent = when;
        $('#p-desc').textContent = desc;
      };

      qsa('#new-form input, #new-form textarea, #new-form select', app).forEach(el => el.addEventListener('input', syncPreview));

      qs('#cover', app).addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f) return; const url = await readFileDataURL(f);
        coverBox.innerHTML = `<img alt="Cover image" src="${url}">`;
      });

      syncPreview();

      qs('#new-form', app).addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = $('#name').value.trim();
        const start = $('#start').value; const end = $('#end').value;
        const desc = $('#desc').value.trim();
        if (!name || !start || !end || !desc) { toast('Please fill in all required fields'); return; }
        if (new Date(end) < new Date(start)) { toast('End time cannot be before start'); return; }
        const host = $('#host').value.trim();
        const bg = $('#bg').value; const fg = $('#fg').value; const font = $('#font').value;
        const coverInput = qs('#cover', app);
        let coverData = '';
        if (coverInput.files?.[0]) coverData = await readFileDataURL(coverInput.files[0]);

        const data = { name, startISO: start, endISO: end, description: desc, hostEmail: host,
          styles: { bg, fg, font }, coverData };
        const eid = await Store.createEvent(data);
        localStorage.setItem(`owner:${eid}`, '1');
        location.hash = `#/event/${eid}`;
        toast('Event created!');
      });

      qs('#btn-home').onclick = () => location.hash = '#/events';
      qs('#btn-new').onclick = () => location.hash = '#/new';
    }

    // --- View: Event ---
    async function showEvent(eid) {
      const app = qs('#app');
      app.innerHTML = '';
      const tpl = qs('#tpl-event');
      const view = tpl.content.cloneNode(true);
      app.appendChild(view);
      const $ = (sel) => qs(sel, app);

      let ev = await Store.getEvent(eid);
      if (!ev) {
        app.innerHTML = `<div class="card"><h3>Event not found</h3><p class="muted">The link may be wrong or the event was removed (local mode).</p><div class="row"><button class="btn" onclick="location.hash='#/new'">Create new</button></div></div>`;
        return;
      }

      function applyThemeAndContent(fromEv) {
        setTheme({ bg: fromEv.styles?.bg || DEFAULT_THEME.bg, fg: fromEv.styles?.fg || DEFAULT_THEME.fg, font: fromEv.styles?.font || DEFAULT_THEME.font });
        const prev = $('#ev-preview');
        prev.style.setProperty('--preview-bg', fromEv.styles?.bg || DEFAULT_THEME.bg);
        prev.style.setProperty('--preview-fg', fromEv.styles?.fg || DEFAULT_THEME.fg);
        prev.style.setProperty('--preview-font', fromEv.styles?.font || DEFAULT_THEME.font);
        $('#ev-title').textContent = fromEv.name;
        $('#ev-when').textContent = fmtDateRange(fromEv.startISO, fromEv.endISO);
        $('#ev-desc').textContent = fromEv.description;
        const cover = $('#ev-cover');
        cover.innerHTML = fromEv.coverData ? `<img alt="Cover image" src="${fromEv.coverData}"/>` : `<span class="muted">No image</span>`;
      }

      applyThemeAndContent(ev);

      // Determine host-only privileges (creator-only in local mode)
      const owner = localStorage.getItem(`owner:${eid}`) === '1';

      // Invite panel
      const link = location.origin + location.pathname + `#/event/${eid}`;
      const mailtoBtn = $('#btn-mailto');
      if (mailtoBtn) {
        const subject = encodeURIComponent(`Invitation: ${ev.name}`);
        const body = encodeURIComponent(`${ev.name}\n${fmtDateRange(ev.startISO, ev.endISO)}\n\n${ev.description}\n\nRSVP at: ${link}`);
        mailtoBtn.href = `mailto:${encodeURIComponent(ev.hostEmail || '')}?subject=${subject}&body=${body}`;
      }
      const copyBtn = $('#btn-copy');
      copyBtn?.addEventListener('click', async () => { await navigator.clipboard.writeText(link); toast('Link copied'); });

      // If NOT owner, enforce Presentation Mode: remove edit & invite UI entirely
      if (!isOwner) {
        $('#owner-hint')?.remove();
        $('#edit-panel')?.remove();
        $('#invite-box')?.remove();
      } else {
        // Owner can see edit controls
        const ownerHint = $('#owner-hint');
        if (ownerHint) ownerHint.hidden = false;
      }

      // RSVP handling (available to everyone)
      const applyCounts = (list) => {
        const yes = list.filter(x => x.status === 'yes').length;
        const maybe = list.filter(x => x.status === 'maybe').length;
        const no = list.filter(x => x.status === 'no').length;
        $('#count-yes').textContent = `Yes: ${yes}`;
        $('#count-maybe').textContent = `Maybe: ${maybe}`;
        $('#count-no').textContent = `No: ${no}`;
      };

      const renderGuests = (list) => {
        const box = $('#guest-list');
        box.innerHTML = '';
        const row = (g) => `<div class="row between"><div>${g.name || 'Unknown'} <span class="muted">&lt;${g.email}&gt;</span></div><div>${g.status === 'yes' ? '✅' : g.status === 'maybe' ? '🤔' : '❌'}</div></div>`;
        list.sort((a,b) => (a.status+'_'+(a.name||'')).localeCompare(b.status+'_'+(b.name||'')));
        list.forEach(g => { const d = document.createElement('div'); d.innerHTML = row(g); box.appendChild(d); });
      };

      const list = await Store.getRSVPs(eid);
      applyCounts(list); renderGuests(list);

      const unsub = Store.subscribeRSVPs(eid, (list) => { applyCounts(list); renderGuests(list); });
      window.addEventListener('beforeunload', () => unsub && unsub());

      const meName = localStorage.getItem('me:name') || '';
      const meEmail = localStorage.getItem('me:email') || '';
      $('#my-name').value = meName; $('#my-email').value = meEmail;

      qsa('[data-rsvp]', app).forEach(btn => btn.addEventListener('click', async () => {
        const name = $('#my-name').value.trim();
        const email = $('#my-email').value.trim();
        if (!email) { toast('Please enter your email'); return; }
        localStorage.setItem('me:name', name); localStorage.setItem('me:email', email);
        const status = btn.getAttribute('data-rsvp');
        await Store.addOrUpdateRSVP(eid, email, name, status);
        toast('Response saved');
        const list = await Store.getRSVPs(eid); applyCounts(list); renderGuests(list);
      }));

      // Owner-only edit handlers (wired regardless; buttons are removed for guests)
      $('#btn-back').onclick = () => history.back();
      const btnEdit = $('#btn-edit');
      if (btnEdit) btnEdit.onclick = () => {
        const p = qs('#edit-panel', app); if (!p) return; p.hidden = !p.hidden;
        if (!p.hidden) fillEditForm();
      };
      const btnSave = $('#btn-save');
      if (btnSave) btnSave.onclick = saveEdits;

      function fillEditForm() {
        qs('#e-name', app).value = ev.name;
        qs('#e-host', app).value = ev.hostEmail || '';
        qs('#e-start', app).value = ev.startISO;
        qs('#e-end', app).value = ev.endISO;
        qs('#e-desc', app).value = ev.description;
        qs('#e-bg', app).value = ev.styles?.bg || DEFAULT_THEME.bg;
        qs('#e-fg', app).value = ev.styles?.fg || DEFAULT_THEME.fg;
        qs('#e-font', app).value = ev.styles?.font || DEFAULT_THEME.font;

        qs('#e-bg', app).oninput = (e) => { setTheme({ bg: e.target.value, fg: qs('#e-fg', app).value, font: qs('#e-font', app).value });
          const temp = { ...ev, styles: { ...ev.styles, bg: e.target.value, fg: qs('#e-fg', app).value, font: qs('#e-font', app).value } };
          applyThemeAndContent(temp);
        };
        qs('#e-fg', app).oninput = (e) => { setTheme({ bg: qs('#e-bg', app).value, fg: e.target.value, font: qs('#e-font', app).value });
          const temp = { ...ev, styles: { ...ev.styles, bg: qs('#e-bg', app).value, fg: e.target.value, font: qs('#e-font', app).value } };
          applyThemeAndContent(temp);
        };
        qs('#e-font', app).oninput = (e) => { setTheme({ bg: qs('#e-bg', app).value, fg: qs('#e-fg', app).value, font: e.target.value });
          const temp = { ...ev, styles: { ...ev.styles, bg: qs('#e-bg', app).value, fg: qs('#e-fg', app).value, font: e.target.value } };
          applyThemeAndContent(temp);
        };
      }

      async function saveEdits() {
        const updated = {
          name: qs('#e-name', app).value.trim(),
          hostEmail: qs('#e-host', app).value.trim(),
          startISO: qs('#e-start', app).value,
          endISO: qs('#e-end', app).value,
          description: qs('#e-desc', app).value.trim(),
          styles: {
            bg: qs('#e-bg', app).value,
            fg: qs('#e-fg', app).value,
            font: qs('#e-font', app).value,
          }
        };
        const f = qs('#e-cover', app).files?.[0];
        if (f) updated.coverData = await readFileDataURL(f);
        await Store.updateEvent(eid, updated);
        ev = { ...ev, ...updated };
        applyThemeAndContent(ev);
        toast('Saved');
      }

      // Update header buttons
      qs('#btn-home').onclick = () => location.hash = '#/events';
      qs('#btn-new').onclick = () => location.hash = '#/new';
    }

    // Bind header buttons (global)
    qs('#btn-home').onclick = () => location.hash = '#/events';
    qs('#btn-new').onclick = () => location.hash = '#/new';

    window.addEventListener('hashchange', route);
    route();
  </script>
</body>
</html>
